from pytorch_framework.utils import CustomCfgNode as CN
from pytorch_framework.utils import update_config


DEF_PARAMS = {
    'linewidth': 0.5,
    'key_linewidth': 1,
}
MPL_RC = {
    'axes.linewidth': DEF_PARAMS['linewidth'],
    'figure.dpi': 100,
    'font.weight': 10,
    'lines.linewidth': DEF_PARAMS['key_linewidth'],
    'xtick.major.size': 3,
    'xtick.major.width': 0.5,
    'xtick.minor.size': 1.5,
    'xtick.minor.width': 0.5,
    'xtick.minor.visible': True,
    'xtick.top': True,
    'xtick.direction': 'in',
    'ytick.major.size': 3,
    'ytick.major.width': 0.5,
    'ytick.minor.size': 1.5,
    'ytick.minor.width': 0.5,
    'ytick.minor.visible': False,
    'ytick.right': True,
    'ytick.direction': 'in',
}


DEFAULT_CONFIG = CN()
DEFAULT_CONFIG.AUTHORIZATION = CN(visible=False)
DEFAULT_CONFIG.AUTHORIZATION.USERS = ['tc404']
DEFAULT_CONFIG.AUTHORIZATION.PASSWORDS = CN(visible=False)
DEFAULT_CONFIG.AUTHORIZATION.PASSWORDS.tc404 = CN(visible=False)
DEFAULT_CONFIG.AUTHORIZATION.PASSWORDS.tc404 = 'tc404'

DEFAULT_CONFIG.DEBUG = CN(visible=False)
DEFAULT_CONFIG.DEBUG.disableConsole = False

DEFAULT_CONFIG.UI = CN()
DEFAULT_CONFIG.UI.SHOW_DAEMON = True

DEFAULT_CONFIG.GENERAL = CN()
DEFAULT_CONFIG.GENERAL.MILEAGE_MARK = 'K'
DEFAULT_CONFIG.GENERAL.MILEAGE_BASE = 113
DEFAULT_CONFIG.GENERAL.CURRENT_MILEAGE = 822.28
DEFAULT_CONFIG.GENERAL.CURRENT_GRADE = 2
DEFAULT_CONFIG.GENERAL.ROCK_GRADES = ['II', 'IIIa', 'IIIb', 'IV', 'V']
DEFAULT_CONFIG.GENERAL.UCS_DIST_PARAMS = [
    (9.91914830266956, 2.4938200281220473e-05, -4.204310801556265e-06, 124.16477930219366, 9.044648204665893e-05),
    (44.44301877939691, 0.40175889819010835, -0.3849282997921526, 177.89055408982466, 0.031186674654849283),
    (19.028627700025417, 11.43149300100859, 10.641265090613345, 6.91644527241229, 2.235237211345466),
    (37.942975904307275, 6.308051291069152, 3.0741603668127846, 5.6226740806294195, 5.848487029041523),
    (8.076331978738569, 0.7337250945661582, 0.727628627056077, 18.63638000475781, 0.015796556311457273)
]
DEFAULT_CONFIG.GENERAL.KV_DIST_PARAMS = [
    (7.9432008093998805, 2.122888856610672, -2.098855730949362, 1.0052402210600215, 0.0009459111821368618),
    (6.707242827834911, 0.0001460729428332556, 1.684135877989942e-06, 0.49804522937431217, 4.3326493235993064e-06),
    (662.7348759005579, 236.4293624613236, -36.09834478436554, 1.019362101549433, 0.62841510786643),
    (5.166417495810752, 4.941537742608599e-05, 7.772000331642418e-07, 0.3830024305879943, 1.993077100433747e-06),
    (249.60228555053652, 12.140916104156332, 1.735033670969579, -0.032780695225051476, 0.0387559308596786)
]
DEFAULT_CONFIG.GENERAL.F_DIST_PARAMS = [
    (12.997070703604333, 1.7900348427417153e-07, -3.782516365476849e-09, 16217.74124917165, 7.730465590653237e-05),
    (3.906728115560541, 0.3691916487117288, -0.2502605563513326, 17991.76360702728, 129.81336879881678),
    (-383.6275441278511, 280.58221749467026, 13.93115850164142, 10925.283832746489, 83723.41844476314),
    (3.6278075085286607, 0.472600501822205, 0.4716653955242455, 3969.4445739510666, 1.7740221798675502),
    (575.8350066042742, 186.94569860223214, 61.395748900492606, -11555.619289013503, 8436.879335829995)
]
DEFAULT_CONFIG.GENERAL.VR_DIST_PARAMS = [
    (14.25247670063965, 0.00044470292432834515, -0.000431452527245209, 8.193828118335624, 1.5288010981832133e-06),
    (-3.9301116678444856, 19.209123260676805, -19.159107301432478, 7.7443192022415985, 0.4745646354195181),
    (3.841987341196617, 4.824040092670298, -4.8240360188890445, 7.6434699928337055, 1.5608751492090453e-06),
    (4.352554166607915, 7.374850127415549, -7.374814839939376, 7.73208817088905, 1.5727212258313892e-05),
    (1.030959933435983, 1.061044265268961e-05, -6.011236396729029e-06, 5.910976198501272, 3.9658419566495315e-06)
]

DEFAULT_CONFIG.BORING_PARAMETER = CN()
DEFAULT_CONFIG.BORING_PARAMETER.DATA_FLD = 'resources/boring_parameter/samples'
DEFAULT_CONFIG.BORING_PARAMETER.DATA_INFO_PATH = 'resources/boring_parameter/sample_info.xlsx'
DEFAULT_CONFIG.BORING_PARAMETER.PREFETCH_COUNT = 2

DEFAULT_CONFIG.IMAGE = CN()
DEFAULT_CONFIG.IMAGE.CREATION_TIME_REGEXP = r'^_([0-9]{6})_([0-9]{9})'
DEFAULT_CONFIG.IMAGE.IMAGE_SIZE = (2048, 2048)
DEFAULT_CONFIG.IMAGE.IMAGE_CROP_ANCHORS = ((0, 0), (0, 2048))
DEFAULT_CONFIG.IMAGE.IMAGE_ROI = (256, 0, 1536, 2048)

DEFAULT_CONFIG.IMAGE_MONITOR = CN()
DEFAULT_CONFIG.IMAGE_MONITOR.BASE_PATH = 'D:/pythondata/test'
DEFAULT_CONFIG.IMAGE_MONITOR.IDLE_THRESH = 60

DEFAULT_CONFIG.NEURAL_NETWORK = CN()
DEFAULT_CONFIG.NEURAL_NETWORK.ENGINE_PATH = 'resources/engine/SlagSplitter_D32_Base_Finetune_Full_INT8_Win.engine'
DEFAULT_CONFIG.NEURAL_NETWORK.IMAGE_MEAN = [0.618]
DEFAULT_CONFIG.NEURAL_NETWORK.IMAGE_STD = [0.229]
DEFAULT_CONFIG.NEURAL_NETWORK.VALID_CATEGORIES = [0]

DEFAULT_CONFIG.POST_PROCESSING = CN()
DEFAULT_CONFIG.POST_PROCESSING.kernel_shape = 'ellipse'
DEFAULT_CONFIG.POST_PROCESSING.kernel_size = 3

DEFAULT_CONFIG.POST_PROCESSING.EXTRACTOR = CN()
DEFAULT_CONFIG.POST_PROCESSING.EXTRACTOR.region_prob_thresh = 0.4
DEFAULT_CONFIG.POST_PROCESSING.EXTRACTOR.boundary_prob_shift = 0.1
DEFAULT_CONFIG.POST_PROCESSING.EXTRACTOR.center_prob_thresh = 0.7
DEFAULT_CONFIG.POST_PROCESSING.EXTRACTOR.center_open_iter = 1
DEFAULT_CONFIG.POST_PROCESSING.EXTRACTOR.erosion_mode = 'direct'
DEFAULT_CONFIG.POST_PROCESSING.EXTRACTOR.max_erosion_iter = 10
DEFAULT_CONFIG.POST_PROCESSING.EXTRACTOR.center_rel_dist_thresh = 3.0
DEFAULT_CONFIG.POST_PROCESSING.EXTRACTOR.gaussian_kernel_size = 15
DEFAULT_CONFIG.POST_PROCESSING.EXTRACTOR.apply_stage2 = True

DEFAULT_CONFIG.POST_PROCESSING.STATISTICAL = CN()
DEFAULT_CONFIG.POST_PROCESSING.STATISTICAL.pixel_ratio = 0.44
DEFAULT_CONFIG.POST_PROCESSING.STATISTICAL.redilate_iter = 2
DEFAULT_CONFIG.POST_PROCESSING.STATISTICAL.grain_size_group = [5, 10, 20, 30, 40, 50, 60, 80, 100, 120, 150, 200, 250, 300]
DEFAULT_CONFIG.POST_PROCESSING.STATISTICAL.ci_size_group = [25, 50, 75, 100, 125, 150, 175, 200]

DEFAULT_CONFIG.POST_PROCESSING.VISUALIZATION = CN()
DEFAULT_CONFIG.POST_PROCESSING.VISUALIZATION.visualization_mode = 'log_area'
DEFAULT_CONFIG.POST_PROCESSING.VISUALIZATION.visualization_alpha = 0.5
DEFAULT_CONFIG.POST_PROCESSING.VISUALIZATION.colormap = 'turbo'
DEFAULT_CONFIG.POST_PROCESSING.VISUALIZATION.draw_contours = True
DEFAULT_CONFIG.POST_PROCESSING.VISUALIZATION.draw_legend = True
DEFAULT_CONFIG.POST_PROCESSING.VISUALIZATION.draw_graindist = True
DEFAULT_CONFIG.POST_PROCESSING.VISUALIZATION.draw_statistics = True
DEFAULT_CONFIG.POST_PROCESSING.VISUALIZATION.result_format = 'png'
DEFAULT_CONFIG.POST_PROCESSING.VISUALIZATION.legend_and_graphs = CN()
DEFAULT_CONFIG.POST_PROCESSING.VISUALIZATION.legend_and_graphs.GLOBAL_ORIGIN = (0, 0)
DEFAULT_CONFIG.POST_PROCESSING.VISUALIZATION.legend_and_graphs.LEGEND_SCALE = 2
DEFAULT_CONFIG.POST_PROCESSING.VISUALIZATION.legend_and_graphs.LEGEND_WIDTH = 250
DEFAULT_CONFIG.POST_PROCESSING.VISUALIZATION.legend_and_graphs.LEGEND_ANCHOR = (30, 30)
DEFAULT_CONFIG.POST_PROCESSING.VISUALIZATION.legend_and_graphs.GRAPH_SIZE = (400, 320)
DEFAULT_CONFIG.POST_PROCESSING.VISUALIZATION.legend_and_graphs.GRAPH_SPACING = 50
DEFAULT_CONFIG.POST_PROCESSING.VISUALIZATION.legend_and_graphs.GRAIN_DIST_GRAPH_WIDTH = 350


def get_default_config():
    return DEFAULT_CONFIG.clone()


def get_config(args, arg_mapper):
    """Get a yacs CfgNode object with default values."""
    # Return a clone so that the defaults will not be altered
    # This is for the "local variable" use pattern
    config = get_default_config()
    update_config(config, args, arg_mapper)

    return config

